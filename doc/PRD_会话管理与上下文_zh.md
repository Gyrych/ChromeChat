# PRD：会话管理与上下文（ChromeChat）

## 1. 背景与目标
本扩展当前支持在弹窗中选择模型并与本地 Ollama 进行单轮对话。用户希望引入“会话”概念：
- 将历史消息作为后续 Prompt 的上下文，形成多轮连续对话；
- 支持保存、加载并继续某个会话；
- 所有会话内容自动保存，无“临时会话”；
- 使用 `/api/chat` 进行对话，以更自然地携带多轮上下文。

目标：在不破坏现有体验的前提下，为弹窗加入会话管理能力，并切换后台接口到 `/api/chat`，使用户可以方便地保存/加载/继续多轮上下文对话。

## 2. 用户与场景
- 用户：熟悉嵌入式开发（C 为主），希望记录/回放/继续先前的技术探讨或问题定位过程。
- 场景：
  - 用户在与模型讨论一个问题时，需要多次往返，下一次打开插件时能从上次的会话继续；
  - 用户根据问题主题维护多个会话，在顶部快速切换；
  - 会话过长时提醒接近模型上下文窗口限制，并给出节选/压缩选项。

## 3. 术语定义
- 会话（Session）：与指定模型绑定的消息序列（user/assistant 多轮消息）。
- 自动保存：每次消息往返完成后，将会话对象持久化；执行“清空对话”前也会自动保存一次。
- 导出：将一个或多个会话以 JSON 文件下载到本地。

## 4. 功能需求
4.1 会话的创建、选择与显示
- 在弹窗顶部提供“会话选择下拉框”：
  - 选项：最近若干会话（按最后活跃时间降序），以及“新建会话”。
  - 选择任一会话后，消息区加载该会话的历史消息。
- 会话与模型绑定：
  - 会话保存所选模型名；加载会话后模型选择器自动切换至该模型（若本地不存在该模型，提示用户）。

4.2 自动保存
- 任何一轮问答完成后，自动保存会话（含双方消息）以及元信息（名称、模型、时间戳等）。
- 执行“清空对话”时，先自动保存当前会话，再清空消息区，但会话本身仍保留在存储中。
- 用户不需要手动保存按钮；但提供“导出”按钮以保存为 JSON。

4.3 加载与继续
- 从顶部下拉切换到目标会话后：
  - 立即在消息区展示历史消息；
  - 发送新消息时，后台改用 `/api/chat`，携带该会话消息作为上下文继续对话。

4.4 会话管理操作
- 重命名会话：允许用户修改会话名称（可选）。
- 删除会话：允许删除单个会话（需确认）。
- 导出会话：
  - 导出单个会话为 JSON；
  - 可选：批量导出所有会话为一个 JSON 数组。
- 导入会话（可选增强）：从 JSON 文件恢复会话；若会话ID冲突可新生成ID。

4.5 UI 细节（弹窗内实现）
- 顶部区域在现有“模型选择器”旁加入“会话下拉框”和简要操作按钮：
  - 下拉：最近会话 + “新建会话”项；
  - 操作按钮：重命名、删除、导出。
- 自动保存后直接清空：
  - 解释：当用户点击“清空对话”按钮时，系统先自动保存当下会话，再清空消息区（会话对象仍在列表中，历史可回看）。

4.6 上下文窗口与容量提醒
- 存储容量：用户期望 50MB；
  - 方案：在 manifest 中申请 `unlimitedStorage`，并使用 `chrome.storage.local`（底层基于 IndexedDB），以获得实际更高上限；
  - 在 PRD 中规定：显示已用空间估算与接近阈值提醒。
- 上下文窗口：根据模型上下文大小提示历史过长风险：
  - 若模型 API 提供上下文窗口信息可直接使用；若无，允许用户在设置中为每个模型配置“上下文窗口”与“保留消息数量/近似 token 上限”。
  - 当预计超限时，提供“仅保留最近N轮”“摘要前文后继续”等选项（后续迭代）。

## 5. 非功能需求
- 兼容性：Chrome Manifest V3。
- 性能：加载会话列表与历史时保持流畅，消息渲染分段追加，避免阻塞 UI。
- 稳定性：网络/接口异常提供清晰错误提示，不影响会话持久化。

## 6. 数据结构（建议）
Session 对象（存入 `chrome.storage.local`，键空间 `ollama.sessions` + `ollama.sessionIndex`）：
```json
{
  "id": "uuid",
  "name": "会话名称（默认：模型名 + 日期）",
  "model": "qwen3:8b",
  "createdAt": 1730457600000,
  "updatedAt": 1730458620000,
  "messages": [
    { "role": "system", "content": "可选：系统提示词" },
    { "role": "user", "content": "你好" },
    { "role": "assistant", "content": "你好！" }
  ]
}
```
索引与元数据：
```json
{
  "sessions": ["uuid1", "uuid2", ...],
  "lastActiveSessionId": "uuid2"
}
```

容量控制与估算：
- 近似 token 估算：`tokens ≈ 字符数 / 4`（粗略）；
- 在保存/发送前估算 messages 总 tokens，若超过阈值则提示。

## 7. 后台接口与对话策略
- 切换到 `/api/chat`：
  - 请求体：`{ model, messages: [{role, content}, ...], stream: false }`
  - 响应：读取 `message.content`（或按 Ollama 标准解析），非流式。
- 前端职责：维护并持久化会话的 `messages`；发送新消息时将完整 messages（或裁剪后的）传给后台。
- 历史截断策略（第一版简单实现）：
  - 发送前保留最近 N 条（N 可配置，如 20 条）；
  - 或基于近似 token 上限截断到“最近几轮”。

## 8. 错误与边界条件
- 模型缺失：加载会话时若模型未安装/不可用，提示并允许选择其他模型（会话仍保留原模型名）。
- 存储接近上限：提示用户导出/清理旧会话；导出后可选择删除以释放空间。
- 数据损坏：对读取失败的会话项做保护性跳过并提示。

## 9. 权限与合规
- `manifest.json` 新增：`"permissions": ["storage"],` 已有；需新增 `"permissions": ["unlimitedStorage"]`；
- `host_permissions` 保持 `http://localhost:11434/*`。

## 10. 交互流程（主要）
1) 启动弹窗 → 测试连接 → 加载模型列表 → 加载最近使用的会话（若有）。
2) 用户在顶部下拉选择会话或“新建会话”。
3) 用户发送消息：
   - 将输入消息追加到该会话 `messages`，调用后台 `/api/chat`；
   - 收到回答后将 assistant 消息追加 → 自动保存会话（更新 `updatedAt`）。
4) 用户点击“清空对话”：
   - 先自动保存（确保当前进度留存），再清空消息区；会话仍在列表中，可再次加载查看全部历史。
5) 导出：
   - 在会话管理按钮中导出当前会话 / 所有会话为 JSON。

## 11. 文档与国际化
- 更新 `README.md` / `README_zh.md` 的 Features 与 Usage。
- 在 `CURSOR.md` 主体中新增会话设计说明，变更记录追加本次 PRD。

## 12. 验收标准（第一版）
- 顶部会话下拉可新建/切换会话，且与模型绑定（切换后模型选择器同步）。
- 多轮对话使用 `/api/chat`，上下文来自会话 `messages`；回答正确追加并持久化。
- 自动保存：每轮问答完成、清空前必定保存；弹窗关闭/重开后会话可恢复。
- 导出 JSON：可导出单个会话与全部会话（UTF-8 JSON）。
- 存储阈值提醒：接近上限时出现明显提示。

—— 以上为第一版实现范围；后续可增补会话搜索、批量删除、消息级别摘要等能力。


