# ChromeChat

**版本：** 0.1.0

**描述：**
ChromeChat 是一个 Chrome 扩展（Manifest V3），允许用户直接在浏览器的弹窗或侧边栏与本地或云端的 Ollama 模型进行交互。

**功能：**
- **互动聊天：** 通过弹窗或侧边栏与 Ollama 模型进行对话。
- **流式与非流式响应：** 支持流式和非流式模式，并具有打字机效果。
- **会话管理：** 创建、读取、更新、删除、导出和导入聊天会话。
- **自动摘要与上下文截断：** 自动总结对话内容并管理上下文长度。
- **页面内容集成：** 获取当前页面的主要内容并作为用户消息发送。
- **停止生成：** 允许中断正在进行的响应。

**目录结构：**
- `popup.html` / `popup.css` / `popup.js`：处理弹窗 UI 和前端逻辑，包括会话管理、输入/输出、模型选择和设置。
- `sidebar.html` / `content_sidebar_inject.js`：管理侧边栏 UI 和注入逻辑。
- `background.js`：作为 Service Worker，处理与 Ollama 的网络交互、流式解析、摘要生成和消息桥接。
- `content_fetch.js`：注入到网页中以提取主要内容供用户消息使用。
- `manifest.json`：定义扩展的元数据和权限。
- `icons/`：包含扩展图标。
- `styles/`：包含共享的 CSS 样式。
- `locales/`：提供多语言的本地化文件。

**安装：**
1. 克隆此仓库。
2. 打开 Chrome，导航至 `chrome://extensions/`。
3. 启用“开发者模式”（右上角的开关）。
4. 点击“加载已解压的扩展程序”，选择克隆的仓库文件夹。

**使用方法：**
- 点击工具栏中的 ChromeChat 图标以打开弹窗。
- 使用侧边栏把手打开/关闭侧边栏。
- 配置设置以连接到本地或云端的 Ollama 模型。
- 开始新会话或继续现有会话，与模型进行聊天。

**配置：**
- **本地 Ollama 模型：**
  - 确保 Ollama 在本地运行并可访问。
  - 在扩展设置中设置 API 端点。
- **云端 Ollama 模型：**
  - 从 Ollama 云服务获取 API 密钥。
  - 在扩展设置中输入 API 密钥。

**已知问题：**
- **CORS 错误：** 确保 `OLLAMA_ORIGINS` 包含扩展的源，并重启 Ollama。
- **响应体不可用：** 切换到非流式模式以获取完整的 JSON 响应。
- **注入失败：** 某些 Chrome 内部页面或 Web Store 可能阻止脚本注入；扩展会检查可注入的 URL。

**安全注意事项：**
- 在生产环境中避免将 `OLLAMA_ORIGINS` 设置为 `*`。
- 安全地存储 Ollama API 密钥，并在不需要时移除。
- 如果将 Ollama 暴露到局域网，请配置防火墙规则以限制访问。

**变更日志：**
- **2025-10-03：** 修复消息持久化顺序；引入写锁。
- **2025-10-05：** 支持 Ollama 云 API 密钥配置，并在请求中注入 Authorization。
- **2025-10-06：** 引入浅色毛玻璃 UI。
- **2025-10-07：** 增加“停止生成”功能；注入侧边栏把手以打开/关闭侧边栏。

**待办与建议改进：**
- 集成 tokenizer 库以获得精确的 token 计数。
- 改进流式兼容性：研究 MessageChannel 或本地代理以更可靠地传递大体量 NDJSON。
- 提供可选的 Ollama 启动脚本/服务，以简化 Windows 启动时的环境变量配置。

*本次草稿由 AI 助手于 2025-10-08 生成并在用户确认后写入项目的 `README_zh.md`。*

